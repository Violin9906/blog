<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>嵌入式Debug日志（1） | Violin&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="alternate" type="application/rss+xml" href="https://violin9906.github.io/blog/rss.xml" title="Violin&#39;s Blog RSS Feed">
    <meta name="description" content="趁着腰伤赋闲在家，把前几天调试STM32的几个BUG给记录一下吧。

0x01 薛定谔的启动模式

在设计FOC驱动模块的时候，我把BLDC的HALL传感器引线和STM32的TIM4 CH1~3连在一起了。本来这个事情很正常，可是问题是我用的是STM32G474CEU6这款MCU，它的TIM4有一个通道和BOOT0是复用的。这个问题本来我没在意，可是当我开始调试的时候，发现有时候复位可以正常 ...">
    
    <link rel="preload" href="/blog/assets/css/0.styles.48e691cf.css" as="style"><link rel="preload" href="/blog/assets/js/app.d7ba5f04.js" as="script"><link rel="preload" href="/blog/assets/js/6.9295e189.js" as="script"><link rel="preload" href="/blog/assets/js/3.b29bc19e.js" as="script"><link rel="preload" href="/blog/assets/js/20.f3d4ed85.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f718410d.js"><link rel="prefetch" href="/blog/assets/js/11.4c3ba3f7.js"><link rel="prefetch" href="/blog/assets/js/12.4f8cacc3.js"><link rel="prefetch" href="/blog/assets/js/13.c2455269.js"><link rel="prefetch" href="/blog/assets/js/14.c6d894d6.js"><link rel="prefetch" href="/blog/assets/js/15.bd565c2d.js"><link rel="prefetch" href="/blog/assets/js/16.81060fc4.js"><link rel="prefetch" href="/blog/assets/js/17.c894ada2.js"><link rel="prefetch" href="/blog/assets/js/18.f58316f0.js"><link rel="prefetch" href="/blog/assets/js/19.0b362288.js"><link rel="prefetch" href="/blog/assets/js/4.94c8ff71.js"><link rel="prefetch" href="/blog/assets/js/5.9286dc81.js"><link rel="prefetch" href="/blog/assets/js/7.9c191a6f.js"><link rel="prefetch" href="/blog/assets/js/8.86b8eb3e.js"><link rel="prefetch" href="/blog/assets/js/9.715043e4.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.548145b0.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.48e691cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">Violin's Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="https://violin9906.github.io/homepage/" target="_blank" rel="noopener noreferrer" class="nav-link external">Home</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="https://violin9906.github.io/homepage/#/contact" target="_blank" rel="noopener noreferrer" class="nav-link external">Contact</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/blog/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">Violin's Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="https://violin9906.github.io/homepage/" target="_blank" rel="noopener noreferrer" class="nav-link external">Home</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="https://violin9906.github.io/homepage/#/contact" target="_blank" rel="noopener noreferrer" class="nav-link external">Contact</a></li> <li class="mobile-nav-item"><a href="/blog/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        嵌入式Debug日志（1）
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Violin</span> <span itemprop="address">   in Wugang</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-04-24T00:00:00.000Z">
      Sat Apr 24 2021
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/嵌入式系统" data-v-42ccfcd5><span data-v-42ccfcd5>嵌入式系统</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/STM32" data-v-42ccfcd5><span data-v-42ccfcd5>STM32</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/自动化" data-v-42ccfcd5><span data-v-42ccfcd5>自动化</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>趁着腰伤赋闲在家，把前几天调试STM32的几个BUG给记录一下吧。</p> <h2 id="_0x01-薛定谔的启动模式">0x01 薛定谔的启动模式</h2> <p>在设计FOC驱动模块的时候，我把BLDC的HALL传感器引线和STM32的TIM4 CH1~3连在一起了。本来这个事情很正常，可是问题是我用的是STM32G474CEU6这款MCU，它的TIM4有一个通道和BOOT0是复用的。这个问题本来我没在意，可是当我开始调试的时候，发现有时候复位可以正常进main，有时候却进不去，而且在调试界面看不到代码。这个时候我发现PC的值不是在0x08000000附近，而是在一个奇怪的位置——Bootloader。</p> <p>仔细一想这个问题很容易解释，在还没有启动的时候，BOOT0脚并没有被我配置成TIM4的输入通道，这个时候它还是BOOT0，所以如果此时转子的位置恰好把这个脚拉到高电平了的话，就无法正常启动了。</p> <p>解决办法也很简单，在ST-Link Utility软件里面配置FLASH的用户配置区FLASH_OPTR，把硬件BOOT0给禁用掉就好了。参考RM0440 2.6节里面的内容如下：</p> <table><thead><tr><th>BOOT_LOCK</th> <th>nBOOT1</th> <th>nBOOT0</th> <th>BOOT0 pin</th> <th>nSWBOOT0</th> <th>启动区</th></tr></thead> <tbody><tr><td>1</td> <td>x</td> <td>x</td> <td>x</td> <td>x</td> <td>主启动区</td></tr> <tr><td>0</td> <td>x</td> <td>x</td> <td>0</td> <td>1</td> <td>主启动区</td></tr> <tr><td>0</td> <td>x</td> <td>1</td> <td>x</td> <td>0</td> <td>主启动区</td></tr> <tr><td>0</td> <td>0</td> <td>x</td> <td>1</td> <td>1</td> <td>SRAM</td></tr> <tr><td>0</td> <td>0</td> <td>0</td> <td>x</td> <td>0</td> <td>SRAM</td></tr> <tr><td>0</td> <td>1</td> <td>x</td> <td>1</td> <td>1</td> <td>Bootloader</td></tr> <tr><td>0</td> <td>1</td> <td>0</td> <td>x</td> <td>0</td> <td>Bootloader</td></tr></tbody></table> <p>最简单的办法，只要把BOOT_LOCK配置为高电平，就可以强制从主启动区启动了。</p> <h2 id="_0x02-hal库垃圾的中断处理">0x02 HAL库垃圾的中断处理</h2> <p>为了用HALL传感器测量电机速度，我配置TIM4使用内部时钟计数，并设置为XOR/HALL模式。在此模式下，HALL传感器任一相的电平变化都会触发TIM4的捕获通道1，捕获此时计数器的值，同时清零计数器。</p> <p>我的想法是，每次进入捕获中断后读取捕获寄存器的值，把这个值作为速度的观测量，值越大速度越慢。可是TIM4是一个16位计数器，最大计数值只有65536，如果在电机转的很慢甚至停转的情况下，计数器溢出了，我要怎么知道此时计数器溢出了呢？</p> <p>最直接的想法是利用溢出时的更新中断，设置一个低速标记位，如果溢出进入更新中断，则将低速标记位置位。如果进入了捕获中断，则清除低速标记位。代码如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BLDC_SetSpeed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hbldc<span class="token punctuation">,</span> <span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hbldc<span class="token punctuation">.</span>LowSpeed <span class="token operator">=</span> FLAG_SET<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HAL_TIM_IC_CaptureCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> ret <span class="token operator">=</span> <span class="token function">Motor_GetHall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Motor_6step</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> hbldc<span class="token punctuation">.</span>RefDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hbldc<span class="token punctuation">.</span>LowSpeed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">BLDC_SetSpeed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hbldc<span class="token punctuation">,</span> htim4<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    hbldc<span class="token punctuation">.</span>LowSpeed <span class="token operator">=</span> FLAG_RESET<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然鹅我很快就发现了问题——这个<code>HAL_TIM_PeriodElapsedCallback()</code>函数，它进不去！</p> <p>排查之后我发现了问题，我在main函数中调用的是<code>HAL_TIMEx_HallSensor_Start_IT(&amp;htim4)</code>来启动定时器的XOR/HALL模式，然而，这个函数中只开启了<code>TIM_IT_CC1</code>这个中断源，并没有开启<code>TIM_IT_UPDATE</code>。找到问题后解决办法也就很简单了，在<code>MX_TIM4_Init()</code>的最后加上一行：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">__HAL_TIM_ENABLE_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_IT_UPDATE <span class="token operator">|</span> TIM_IT_CC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>本以为这样就完事大吉了，可谁知这下子问题更大了，不管电机转没转，低速标记位始终都被置位。其实更新中断并不只有在溢出的时候才会触发，而是在很多情况下都会触发，其中包括当CNT寄存器通过UG位软复位和被触发事件复位这两种情况。XOR/HALL模式下，CNT寄存器的复位是通过触发通道实现的，所以同时也会触发更新中断。</p> <p>但是，天无绝人之路。RM0440 28.6.5节中指出，这两种情况需要URS=0才会触发中断。那什么是URS呢？它是TIMx_CR1中的bit2，Update Request Source。RM0440中是这样写的：</p> <blockquote><p>This bit is set and cleared by software to select the UEV event sources.</p> <p>0: Any of the following events generate an update interrupt or DMA request if enabled. These events can be:</p> <p>​	–   Counter overflow/underflow</p> <p>​	–   Setting the UG bit</p> <p>​	–   Update generation through the slave mode controller</p> <p>1: Only counter overflow/underflow generates an update interrupt or DMA request if enabled</p></blockquote> <p>如果把URS位置位，就可以只在CNT寄存器溢出的时候，才触发更新中断。在<code>MX_TIM4_Init()</code>最后加上一行：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">SET_BIT</span><span class="token punctuation">(</span>htim4<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>CR1<span class="token punctuation">,</span> TIM_CR1_URS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>完美解决。</p> <h2 id="_0x03-小结">0x03 小结</h2> <p>遇事不决，查手册！</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_0x01-薛定谔的启动模式" title="0x01 薛定谔的启动模式">0x01 薛定谔的启动模式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_0x02-hal库垃圾的中断处理" title="0x02 HAL库垃圾的中断处理">0x02 HAL库垃圾的中断处理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_0x03-小结" title="0x03 小结">0x03 小结</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/Violin9906" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:violinwang@mail.ustc.edu.cn" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://violin9906.github.io/homepage/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe" data-v-3d9deeb8><circle cx="12" cy="12" r="10" data-v-3d9deeb8></circle><line x1="2" y1="12" x2="22" y2="12" data-v-3d9deeb8></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="http://creativecommons.org/licenses/by-sa/3.0/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>本页面采用CC BY-SA 3.0协议发布</a></li><li class="copyright-item" data-v-3d9deeb8><a href="/blog/" class="nav-link" data-v-3d9deeb8>源代码采用MIT许可协议</a></li><li class="copyright-item" data-v-3d9deeb8><a href="/blog/" class="nav-link" data-v-3d9deeb8>Copyright © 2020 王若麟</a></li><li class="copyright-item" data-v-3d9deeb8><a href="https://vuepress-theme-blog.ulivz.com/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>POWERED BY VUEPRESS</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.d7ba5f04.js" defer></script><script src="/blog/assets/js/6.9295e189.js" defer></script><script src="/blog/assets/js/3.b29bc19e.js" defer></script><script src="/blog/assets/js/20.f3d4ed85.js" defer></script>
  </body>
</html>
